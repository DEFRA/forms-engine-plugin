{% from "partials/components.html" import componentList %}
{% from "govuk/components/fieldset/macro.njk" import govukFieldset %}
{% from "govuk/components/hint/macro.njk" import govukHint %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}

{% macro UkAddressField(component) %}
  {% set fieldset = component.model.fieldset %}
  {% set usePostcodeLookup = component.model.usePostcodeLookup %}

  {% set addressFieldHtml %}
    <div {{"hidden" if usePostcodeLookup }}>
      {{ componentList(component.model.components) }}
    </div>
  {% endset %}

  {% if component.model.hint %}
    {% set addressHintHtml %}
      {{ govukHint({
        id: component.model.name + "-hint",
        text: component.model.hint.text
      } if fieldset else component.model.hint) }}
    {% endset %}

    {% set addressFieldHtml = addressHintHtml + addressFieldHtml %}
  {% endif %}

  {{ govukFieldset({
    legend: fieldset.legend,
    attributes: fieldset.attributes,
    html: addressFieldHtml
  }) if fieldset else addressFieldHtml }}

  {% if usePostcodeLookup %}
    {% set postcodeLookupBaseUrl = component.model.postcodeLookupBaseUrl %}
    {% set postcodeLookupQuery = component.model.postcodeLookupQuery %}
    {% set value = component.model.value %}
    {% set postcodeLookupHref = postcodeLookupBaseUrl + "/" + slug + page.path + "/" + component.model.name + "?" + postcodeLookupQuery %}

    {% if value %}
      {% set insetHtml %}
        <strong>Selected address:</strong>
        <br><br>
        {{ value }}
        <br><br>
        <a href="{{ postcodeLookupHref }}" class="govuk-link govuk-link--no-visited-state">Use a different address</a>
      {% endset %}

      {{ govukInsetText({
        html: insetHtml,
        classes: "govuk-!-margin-top-2"
      }) }}
    {% else %}
      <div class="govuk-button-group">
        {{ govukButton({
          text: "Find an address",
          href: postcodeLookupHref,
          classes: "govuk-button--secondary govuk-!-margin-right-1"
        }) }}
        <p class="govuk-body">or <a href="{{ postcodeLookupHref }}&step=manual" class="govuk-link govuk-link--no-visited-state">enter address manually</a></p>
      </div>
    {% endif %}
  {% endif %}
{% endmacro %}
